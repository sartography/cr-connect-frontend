<div class="studies-container" fxLayout="column">
  <h1>Studies</h1>
  <div
    class="alert alert-info"
    fxFlex="100"
  >
    <p>To start a new study, first go to HSR IRB Protocol Builder and create a new protocol. When your protocol has
      been created, return here to continue working on it.</p>
    <div fxLayout="row" fxLayoutGap="40px" fxLayoutAlign="center center">
      <a
        [href]="irbUrl"
        color="primary"
        id="cta_protocol_builder"
        mat-flat-button
        target="_blank"
      >
        <mat-icon>add</mat-icon>
        Create new protocol
        <mat-icon>open_in_new</mat-icon>
      </a>
      <a
        (click)="loading = true; loadStudies()"
        color="accent"
        id="cta_reload_studies"
        mat-flat-button
        target="_blank"
      >
        <mat-icon>refresh</mat-icon>
        Check for new protocols
      </a>
    </div>
  </div>

  <div *ngIf="!loading; else loadingMessage">
    <mat-expansion-panel *ngFor="let studiesGroup of studiesByStatus; let i = index;" [expanded]="studiesGroup.studies.length > 0">
      <mat-expansion-panel-header>
        <mat-panel-title class="mat-h2">
          {{studiesGroup.statusLabel}}
          <mat-chip-list>
            <mat-chip [selectable]="false" [ngClass]="studiesGroup.status.toString().toLowerCase()">{{studiesGroup.studies.length}}</mat-chip>
          </mat-chip-list>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <div class="status-{{studiesGroup.status.toString().toLowerCase()}}" fxLayout="row wrap" fxLayoutGap="40px">
        <table mat-table [dataSource]="studiesGroup.dataSource" matSort class="mat-elevation-z0">
          <ng-container matColumnDef="title">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Name </th>
            <td mat-cell *matCellDef="let study"> {{study.title}} </td>
          </ng-container>

          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Study ID </th>
            <td mat-cell *matCellDef="let study"> {{study.id}} </td>
          </ng-container>

          <ng-container matColumnDef="progress">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Progress </th>
            <td mat-cell *matCellDef="let study"><app-study-progress [study]="study"></app-study-progress></td>
          </ng-container>

          <ng-container matColumnDef="protocol_builder_status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
            <td mat-cell *matCellDef="let study"> {{study.protocol_builder_status}} </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let study; columns: displayedColumns;"
            [routerLink]="['/study', study.id]"
            [ngClass]="'study-row'"
            [attr.data-study-id]="study.id"
          ></tr>
        </table>
      </div>
    </mat-expansion-panel>
  </div>
</div>

<ng-template #loadingMessage>
  <div class="loading" fxLayoutAlign="center center">
    <mat-spinner></mat-spinner>
  </div>
</ng-template>
