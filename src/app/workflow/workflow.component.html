<mat-sidenav-container>
  <mat-sidenav opened mode="side" position="start" [fixedInViewport]="true" [fixedTopGap]="64">
    <button
      mat-button
      [routerLink]="['/study', studyId]"
      [queryParams]="{category: workflowSpec && workflowSpec.category_id}"
      [ngClass]="'back'"
    >
      <mat-icon>chevron_left</mat-icon>
      Back
    </button>

    <h3>
      Tasks
      <span fxFlex></span>
      <button
        mat-button
        (click)="confirmResetWorkflow()"
      >
        <mat-icon>undo</mat-icon>
        Start over
      </button>
    </h3>
    <app-workflow-steps-menu-list *ngFor="let task of allTasks"
      [task]="task"
      [isCurrent] = "currentTask && task.id === currentTask.id"
      (taskSelected)="setCurrentTask($event)"
    ></app-workflow-steps-menu-list>
  </mat-sidenav>
  <mat-sidenav-content>
    <h4 class="mat-card-subtitle">{{workflowSpec && workflowSpec.display_name}}</h4>
    <div fxLayout="row" fxLayoutAlign="end">
      <button
        mat-icon-button
        title="Files for this task"
        (click)="toggleFilesDisplay()"
        [ngClass]="{'selected': displayFiles}"
        *ngIf="fileMetas && fileMetas.length > 0"
      >
        <mat-icon>attachment</mat-icon>
      </button>
      <button
        mat-icon-button
        title="Display collected task data"
        (click)="toggleDataDisplay()"
        [ngClass]="{'selected': displayData}"
      >
        <mat-icon>chrome_reader_mode</mat-icon>
      </button>
    </div>
    <app-workflow-form *ngIf="hasIncompleteUserTask(); else noTask"
      [task]="currentTask"
      [workflow]="workflow"
      (workflowUpdated)="workflowUpdated($event)"
    ></app-workflow-form>
  </mat-sidenav-content>
  <mat-sidenav
    [opened]="displayData || displayFiles"
    mode="side"
    position="end"
    [fixedInViewport]="true"
    [fixedTopGap]="64"
    [ngClass]="{'files-display': displayFiles, 'data-display': displayData}"
  >
    <div *ngIf="!displayData && displayFiles" id="files-display-column">
      <app-workflow-files *ngIf="workflow" [workflow]="workflow" [fileMetas]="fileMetas"></app-workflow-files>
    </div>
    <div *ngIf="!displayFiles && displayData" id="data-display-column">
      <app-code-viewer
        *ngIf="workflow && currentTask && currentTask.data"
        [data]="currentTask.data"
      ></app-code-viewer>
    </div>
  </mat-sidenav>
</mat-sidenav-container>

<ng-template #noTask>
  <div class="task-status" fxLayout="column" fxLayoutAlign="stretch stretch">
    <div class="non-user-task" *ngIf="currentTask">
      <div class="documentation" *ngIf="currentTask.documentation">
        <markdown [data]="currentTask.documentation"></markdown>
      </div>
      <button *ngIf="currentTask.type == taskTypes.MANUAL_TASK" (click)="completeManualTask(currentTask)"
              color="primary" mat-flat-button>Continue</button>
      <div *ngIf="!currentTask.documentation">
        <h1>{{currentTask.display_name()}}</h1>
        <h2>Task type: {{currentTask.type}}</h2>
        <h3>Status: {{currentTask.state}}</h3>
        <p>Please add documentation to this event to provide users with a custom message
        about their progress.</p>
        <div class="task-data">
          <app-code-viewer [data]="currentTask.data"></app-code-viewer>
        </div>
      </div>
    </div>
    <div class="no-task" *ngIf="!currentTask">
      <h1>No tasks found.</h1>
      <p>This workflow does not have any tasks in it.</p>
    </div>
  </div>
</ng-template>
