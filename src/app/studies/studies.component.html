<div class="studies-container" fxLayout="column">
  <div class="nav" fxFlex="100">
    <a mat-button [routerLink]="['/']" routerLinkActive="active">Dashboard View</a>
    <mat-divider [vertical]="true"></mat-divider>
    <a mat-button [routerLink]="['/process']" routerLinkActive="active">Process View</a>
    <span fxFlex></span>
    <a
      [href]="irbUrl"
      color="primary"
      id="cta_protocol_builder"
      mat-button
      target="_blank"
    >
      <mat-icon>add</mat-icon>
      Create new protocol
      <mat-icon>open_in_new</mat-icon>
    </a>
    <a
      (click)="loading = true; loadStudies()"
      color="accent"
      id="cta_reload_studies"
      mat-button
      target="_blank"
    >
      <mat-icon>refresh</mat-icon>
      Check for new protocols
    </a>
  </div>

  <div *ngIf="!loading; else loadingMessage">
    <mat-expansion-panel
      *ngFor="let studiesGroup of studiesByStatus; let i = index;"
      [expanded]="studiesGroup.studies.length > 0"
      class="mat-elevation-z0"
    >
      <mat-expansion-panel-header>
        <mat-panel-title class="mat-h2">
          {{studiesGroup.statusLabel}}
          <mat-chip-list>
            <mat-chip [selectable]="false" [ngClass]="studiesGroup.status.toString().toLowerCase()">{{studiesGroup.studies.length}}</mat-chip>
          </mat-chip-list>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <div class="status-{{studiesGroup.status.toString().toLowerCase()}}" fxLayout="row wrap" fxLayoutGap="40px">
        <table mat-table [dataSource]="studiesGroup.dataSource" matSort class="mat-elevation-z0">
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Study ID </th>
            <td mat-cell *matCellDef="let study"> {{study.id}} </td>
          </ng-container>

          <ng-container matColumnDef="title">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Study Title </th>
            <td mat-cell *matCellDef="let study"> {{study.title}} </td>
          </ng-container>

          <ng-container matColumnDef="irb_hsr_status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> IRB HSR Status </th>
            <td mat-cell *matCellDef="let study">
              {{study.protocol_builder_status}}
            </td>
          </ng-container>

          <ng-container matColumnDef="protocol_builder_status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> PB Status </th>
            <td mat-cell *matCellDef="let study">
              {{study.protocol_builder_status}}
              <span class="new" *ngIf="isNewStudy(study.id)">NEW</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="progress">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Progress </th>
            <td mat-cell *matCellDef="let study"><app-study-progress [study]="study"></app-study-progress></td>
          </ng-container>

          <ng-container matColumnDef="committees_complete">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Internal Committees Complete </th>
            <td mat-cell *matCellDef="let study">
              0/0
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let study; columns: displayedColumns;"
            [routerLink]="['/study', study.id]"
            [ngClass]="{'study-row': true, 'new': isNewStudy(study.id)}"
            [attr.data-study-id]="study.id"
          ></tr>
        </table>
      </div>
    </mat-expansion-panel>
  </div>
</div>

<ng-template #loadingMessage>
  <div class="loading" fxLayoutAlign="center center">
    <mat-spinner></mat-spinner>
  </div>
</ng-template>
